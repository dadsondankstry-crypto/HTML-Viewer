<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HTML Viewer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #007bff; --success: #28a745; --bg: #f0f2f5; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }
        
        .container { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* Bot√µes de Configura√ß√£o (Toggles Simplificados) */
        .config-btn { 
            padding: 15px; border-radius: 12px; border: 2px solid #ccc;
            background: white; cursor: pointer; font-weight: bold;
            display: flex; justify-content: center; align-items: center; /* Centralizado sem texto ON/OFF */
            transition: all 0.3s ease;
            text-align: center;
        }
        .config-btn.active { 
            border-color: var(--success); 
            color: var(--success); 
            background: #eaffea; 
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.2);
        }

        /* Bot√µes de A√ß√£o */
        .btn-acao { 
            padding: 18px; font-size: 16px; font-weight: bold; border: none; 
            border-radius: 12px; cursor: pointer; color: white; transition: opacity 0.2s;
        }
        .btn-colar { background: var(--success); }
        .btn-salvar { background: var(--primary); }
        .btn-share { background: #6f42c1; }
        .btn-acao:active { opacity: 0.8; }

        /* Viewer Fullscreen */
        #viewer-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; display: none; z-index: 998; 
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* Bot√£o Flutuante M√≥vel (Sempre Olho) */
        #dragBtn { 
            position: fixed; bottom: 30px; right: 30px; 
            width: 65px; height: 65px; background: var(--primary); 
            color: white; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-size: 28px;
            z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            touch-action: none; user-select: none;
            transition: transform 0.2s;
        }
        #dragBtn:active { transform: scale(0.95); }

        /* Toast de Notifica√ß√£o */
        #toast { 
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; 
            border-radius: 30px; display: none; z-index: 1002; font-size: 14px; text-align: center;
        }

        textarea { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>HTML Viewer</h2>
    
    <div id="btnAuto" class="config-btn" onclick="toggleCfg('auto')">
        Auto-Abrir ao Colar
    </div>

    <div id="btnGesto" class="config-btn" onclick="toggleCfg('gesto')">
        Modo Gesto / Ocultar Bot√£o
    </div>

    <button class="btn-acao btn-colar" onclick="executarColar()">COLAR C√ìDIGO</button>
    <button class="btn-acao btn-salvar" onclick="gerarArquivo('salvar')">SALVAR .HTML</button>
    <button class="btn-acao btn-share" onclick="gerarArquivo('share')">COMPARTILHAR</button>
</div>

<textarea id="hiddenStorage"></textarea>
<div id="viewer-container"><iframe id="contentFrame"></iframe></div>
<div id="dragBtn">üëÅÔ∏è</div>
<div id="toast"></div>

<script>
    const storage = document.getElementById('hiddenStorage');
    const frame = document.getElementById('contentFrame');
    const vContainer = document.getElementById('viewer-container');
    const dragBtn = document.getElementById('dragBtn');
    
    // Carregar Configura√ß√µes Salvas
    let cfg = {
        auto: localStorage.getItem('cfg_auto') === 'true',
        gesto: localStorage.getItem('cfg_gesto') === 'true'
    };

    function atualizarInterface() {
        // Apenas adiciona/remove a classe .active (mudan√ßa de cor)
        document.getElementById('btnAuto').className = cfg.auto ? 'config-btn active' : 'config-btn';
        document.getElementById('btnGesto').className = cfg.gesto ? 'config-btn active' : 'config-btn';
        
        // Se o Modo Gesto estiver ativo, podemos ocultar o bot√£o (opcional, conforme sua prefer√™ncia)
        // Por enquanto, mantive o bot√£o vis√≠vel pois ele √© o √∫nico controle de sair.
    }
    atualizarInterface();

    function toggleCfg(tipo) {
        cfg[tipo] = !cfg[tipo];
        localStorage.setItem('cfg_'+tipo, cfg[tipo]);
        atualizarInterface();
        avisar(cfg[tipo] ? "Ativado" : "Desativado");
    }

    function avisar(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    async function executarColar() {
        try {
            const txt = await navigator.clipboard.readText();
            storage.value = txt;
            avisar("Conte√∫do Colado!");
            if(cfg.auto) alternarVisualizacao(true);
        } catch(e) { avisar("Erro ao ler √°rea de transfer√™ncia."); }
    }

    function alternarVisualizacao(forcarAbrir = null) {
        const estaAberto = vContainer.style.display === 'block';
        // Se forcarAbrir for null, inverte o estado atual (toggle)
        const novoEstado = forcarAbrir !== null ? forcarAbrir : !estaAberto;

        if(novoEstado) {
            // ABRIR
            if(!storage.value) return avisar("Cole um c√≥digo primeiro!");
            frame.srcdoc = storage.value;
            vContainer.style.display = 'block';
            // Adiciona estado ao hist√≥rico para permitir o bot√£o "Voltar" do celular
            history.pushState({viewer: true}, "Viewer", "#viewer");
        } else {
            // FECHAR/SAIR
            vContainer.style.display = 'none';
            frame.srcdoc = ""; // Limpa para economizar mem√≥ria
            // Se tiver hist√≥rico de viewer, volta atr√°s para n√£o quebrar a navega√ß√£o
            if(history.state && history.state.viewer) history.back();
        }
        // O bot√£o continua sendo 'üëÅÔ∏è' visualmente
    }

    // Atalhos: Tecla ESC e Bot√£o Voltar do Navegador (Gesto do Celular)
    window.addEventListener('keydown', (e) => { 
        if(e.key === "Escape" && vContainer.style.display === 'block') alternarVisualizacao(false); 
    });

    window.addEventListener('popstate', (e) => {
        // Se o usu√°rio usar o gesto de voltar do celular, fecha o viewer
        if(vContainer.style.display === 'block') {
            vContainer.style.display = 'none';
        }
    });

    // L√≥gica do Bot√£o Flutuante (Arrastar e Clicar)
    let holdTimer, movendo = false;
    let startX, startY;

    dragBtn.addEventListener('touchstart', (e) => {
        let t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
        holdTimer = setTimeout(() => { movendo = true; dragBtn.style.opacity = '0.7'; }, 200);
    }, {passive: false});

    dragBtn.addEventListener('touchmove', (e) => {
        if(!movendo) return;
        e.preventDefault(); // Evita scroll enquanto arrasta
        let t = e.touches[0];
        dragBtn.style.left = (t.clientX - 32) + 'px';
        dragBtn.style.top = (t.clientY - 32) + 'px';
        dragBtn.style.bottom = 'auto'; dragBtn.style.right = 'auto';
    }, {passive: false});

    dragBtn.addEventListener('touchend', () => {
        clearTimeout(holdTimer);
        dragBtn.style.opacity = '1';
        if(!movendo) {
            // Clique simples: Alterna visualiza√ß√£o (Abre ou Sai)
            alternarVisualizacao(); 
        }
        movendo = false;
    });
    
    // Suporte a clique de mouse (Desktop)
    dragBtn.addEventListener('click', () => {
        // Apenas se n√£o for touch (para evitar duplo disparo em alguns devices)
        if ('ontouchstart' in window) return;
        alternarVisualizacao();
    });

    function gerarArquivo(modo) {
        const cod = storage.value;
        if(!cod) return avisar("Sem conte√∫do!");
        
        const buscaTitulo = cod.match(/<title>(.*?)<\/title>/i);
        const nomeFinal = buscaTitulo ? buscaTitulo[1].trim() : "arquivo_html";
        
        const blob = new Blob([cod], {type:'text/html'});

        if(modo === 'salvar') {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = nomeFinal + ".html";
            link.click();
            avisar("Arquivo baixado!");
        } else {
            const file = new File([blob], nomeFinal + ".html", {type:'text/html'});
            if(navigator.share) {
                navigator.share({files:[file], title: nomeFinal});
            } else { avisar("Erro no compartilhamento."); }
        }
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>